<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surat Bebas Asrama - Pengelola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>

<style>
    #proofImage {
        cursor: zoom-in;
        transition: transform 0.2s ease-in-out;
    }
    #proofImage.zoomed-in {
        transform: scale(1.5); /* Anda bisa ubah angka ini untuk perbesaran yang berbeda */
        cursor: zoom-out;
    }
 
        
    table.dataTable thead {
        background-color: #f3f4f6;
        font-weight: 600;
    }
    
    table.dataTable tbody tr:hover {
        background-color: #f9fafb;
    }
    /* Atur ukuran tabel utama */
    table.dataTable {
        width: 100%;             /* Biar tabel full container */
        max-width: 100%;         /* Jangan melebihi container */
        border-collapse: collapse;
        font-size: 0.9rem;       /* Ukuran font tabel */
    }

    /* Atur ukuran cell (td, th) */
    table.dataTable th,
    table.dataTable td {
        padding: 0.75rem 1rem;   /* Spasi dalam sel */
        text-align: left;        /* Rata kiri */
        vertical-align: middle;  /* Tengah vertikal */
    }

    /* Kalau tabel terlalu panjang, buat scroll horizontal */
    .dataTables_wrapper {
        overflow-x: auto;
    }

    /* Atur tinggi baris */
    table.dataTable tbody tr {
        height: 2.5rem;          /* Atur tinggi minimum baris */
    }


    /* Mengatur header: "Show entries" & "Search" */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 1.5rem;
        margin-top: 0.5rem;
        margin-left: 1.5rem;
        margin-right: 1.5rem;
    }

    /* Mengatur footer: "Showing..." & Paginasi */
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        margin-top: 1.5rem;
        margin-left: 1.5rem;
        margin-bottom: 1rem;
        margin-right: 1.5rem;

    }

    /* Menata ulang posisi header dan footer dengan flexbox */
    .dt-layout-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Styling untuk input search agar lebih modern */
    .dataTables_wrapper .dataTables_filter input {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.25rem 0.75rem;
        margin-left: 0.5rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .dataTables_wrapper .dataTables_filter input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
    }

    /* Styling untuk tombol paginasi */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.25rem 0.5rem;
        margin: 0 0.25rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #3b82f6 !important; /* Paksa override style */
        color: white !important;
        border-color: #3b82f6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
</style>

<body class="lg:ml-52 bg-gray-50">
    <div class="bg-white rounded-lg shadow-sm border">
        <div class="px-6 py-4 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Daftar Pengajuan Surat Bebas Asrama</h2>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table id="submissionTable" class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIM</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Pengajuan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Pengajuan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Update</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Data akan dimuat melalui JavaScript -->
                </tbody>
            </table>
        </div>
    </div>


            <!-- Modal Detail -->
            <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
                        
                        <!-- Header Modal -->
                        <div class="px-6 py-4 border-b flex-shrink-0">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Detail Pengajuan Surat Bebas Asrama</h3>
                                <button onclick="closeModal('detailModal')" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Konten Modal -->
                        <div class="px-6 py-4 overflow-y-auto flex-grow">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                
                                <!-- Informasi Mahasiswa -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-user mr-2 text-blue-600"></i>
                                        Informasi Mahasiswa
                                    </h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Nama:</span>
                                            <span class="font-medium" id="detailName">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">NIM:</span>
                                            <span class="font-medium" id="detailNim">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Jurusan:</span>
                                            <span class="font-medium" id="detailJurusan">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Status Pengajuan -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-clipboard-check mr-2 text-green-600"></i>
                                        Status Pengajuan
                                    </h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Nomor Pengajuan:</span>
                                            <span class="font-medium" id="detailSubmissionNumber">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Status:</span>
                                            <span class="font-medium" id="detailStatus">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Tanggal Pengajuan:</span>
                                            <span class="font-medium" id="detailSubmissionDate">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Tanggal Update:</span>
                                            <span class="font-medium" id="detailUpdateDate">-</span>
                                        </div>
                                         <div class="flex justify-between">
                                            <span class="text-gray-600">Status Bukti:</span>
                                            <span class="font-medium" id="detailPaymentProof">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rincian Biaya -->
                             <div class="bg-gray-50 rounded-lg p-4 md:col-span-2">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-file-invoice-dollar mr-2 text-purple-600"></i>
                                    Rincian Biaya
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between py-2 border-b border-gray-200">
                                        <span class="text-gray-600">Status Fasilitas:</span>
                                        <span class="font-medium" id="detailFacilities">-</span>
                                    </div>

                                    <div id="facilityListDetail" class="hidden py-2 border-b border-gray-200">
                                        <div>
                                            <span class="text-gray-600">Rincian Biaya:</span>
                                            <div id="facilityItems" class="pl-4 mt-1 space-y-1">
                                                </div>
                                        </div>
                                    </div>

                                    <div class="flex justify-between items-center pt-3">
                                        <span class="text-base font-bold text-gray-800">Total :</span>
                                        <span class="text-lg font-bold text-green-600" id="detailTotalAmount">-</span>
                                    </div>
                                </div>
                            </div>
                            
            

                            <!-- Daftar Fasilitas yang Perlu Dibayar -->
                            <div id="facilityListDetail" class="mt-6 hidden">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-list mr-2 text-blue-600"></i>
                                        Daftar Fasilitas yang Perlu Dibayar
                                    </h4>
                                    <div id="facilityItems" class="space-y-2">
                                        <!-- Fasilitas akan ditampilkan di sini -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                                            <!-- Footer Modal -->
                        <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
                            <button onclick="closeModal('detailModal')" class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm font-medium transition-colors">
                                Tutup
                            </button>
                        </div>
                </div>
            </div>
                    <!-- Daftar Fasilitas yang Perlu Dibayar -->
                    <div id="facilityListDetail" class="mt-6 hidden">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-list mr-2 text-blue-600"></i>
                                Daftar Fasilitas yang Perlu Dibayar
                            </h4>
                            <div id="facilityItems" class="space-y-2">
                                <!-- Fasilitas akan ditampilkan di sini -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Verifikasi Fasilitas -->
    <div id="facilityVerificationModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-800">Verifikasi Fasilitas</h3>
                        <button onclick="closeModal('facilityVerificationModal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <p class="mb-4"><strong>Nama:</strong> <span id="facilityStudentName"></span></p>
                    <p class="mb-4"><strong>Status Kelengkapan:</strong></p>
                    
                    <div class="space-y-3 mb-4">
                        <label class="flex items-center">
                            <input type="radio" id="complete" name="completeness" value="complete" onchange="toggleFacilityForm()" class="mr-2">
                            <span class="text-sm">Lengkap</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="radio" id="incomplete" name="completeness" value="incomplete" onchange="toggleFacilityForm()" class="mr-2">
                            <span class="text-sm">Tidak Lengkap</span>
                        </label>
                    </div>
                    
                    <div id="facilityForm" class="hidden">
                        <h4 class="font-medium text-gray-800 mb-3">Daftar Fasilitas yang Perlu Dibayar:</h4>
                        <div id="facilityList" class="space-y-2 mb-3">
                            <div class="flex gap-2 items-center facility-item">
                                <input type="text" placeholder="Nama Fasilitas" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="number" placeholder="Harga" class="w-24 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 facility-price" onchange="calculateTotal()">
                                <button type="button" onclick="removeFacility(this)" class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" onclick="addFacility()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-medium mb-4">
                            <i class="fas fa-plus mr-1"></i>Tambah Fasilitas
                        </button>
                        
                        <div class="border-t pt-3">
                            <div class="text-right font-semibold text-gray-800">
                                Total: Rp <span id="totalAmount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-2">
                    <button onclick="closeModal('facilityVerificationModal')" class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm font-medium transition-colors">
                        Batal
                    </button>
                    <button id="submitFacilityBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium">
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- modal verifikasi bayar -->
<div id="paymentVerificationModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Verifikasi Pembayaran</h3>
                    <button onclick="closeModal('paymentVerificationModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <div class="bg-gray-100 rounded-lg flex items-center justify-center p-4 mb-4">
                    <img id="proofImage" src="" alt="Bukti Pembayaran" class="max-w-full max-h-full object-contain">
                    <p id="proofPlaceholder" class="text-gray-500 hidden">Bukti pembayaran tidak tersedia.</p>
                </div>

                <div>
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <p class="mb-2"><strong>Nama:</strong> <span id="paymentStudentName"></span></p>
                        <p class="mb-2"><strong>Total Tagihan:</strong> <span class="text-green-600 font-semibold" id="paymentAmount"></span></p>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah bukti pembayaran sudah sesuai dan dapat diverifikasi?</p>
                    
                    <div class="flex justify-end space-x-2">
                        <button id="rejectPaymentBtn" class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm font-medium">
                            <i class="fas fa-times mr-1"></i> Tidak, Tolak
                        </button>
                        <button id="approvePaymentBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium">
                            <i class="fas fa-check mr-1"></i> Ya, Verifikasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
    // =================================================================
    // BAGIAN FUNGSI GLOBAL & STATE
    // Didefinisikan di sini agar bisa diakses oleh onclick dari DataTables
    // =================================================================
    let allSubmissions = [];
    let currentSubmissionId = null;
    let datatable;

    // --- Fungsi Helper Formatting ---
    const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';
    const formatCurrency = (a) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(a);

    function getStatusBadge(status) {
        const statuses = {
            'VERIFIKASI_FASILITAS': { badge: '<i class="fas fa-clipboard-check mr-1"></i>Verifikasi Fasilitas', class: 'bg-purple-100 text-purple-800' },
            'MENUNGGU_PEMBAYARAN': { badge: '<i class="fas fa-clock mr-1"></i>Menunggu Pembayaran', class: 'bg-amber-100 text-amber-800' },
            'VERIFIKASI_PEMBAYARAN': { badge: '<i class="fas fa-search mr-1"></i>Verifikasi Pembayaran', class: 'bg-blue-100 text-blue-800' },
            'SELESAI': { badge: '<i class="fas fa-check mr-1"></i>Selesai', class: 'bg-green-100 text-green-800' }
        };
        return statuses[status] || { badge: 'Unknown', class: 'bg-gray-100 text-gray-800' };
    }

    // --- Fungsi Modal (dijadikan global dengan window.) ---
    window.closeModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            if (modalId === 'facilityVerificationModal') {
                document.querySelectorAll('input[name="completeness"]').forEach(radio => radio.checked = false);
                toggleFacilityForm();
            }
        }
    };

    window.openDetailModal = function(id) {
        currentSubmissionId = id;
        const submission = allSubmissions.find(s => s.Surat_id === id);
        if (!submission) return;

        document.getElementById('detailName').textContent = submission.mahasiswa.nama;
        document.getElementById('detailNim').textContent = submission.mahasiswa.nim;
        document.getElementById('detailJurusan').textContent = submission.mahasiswa.jurusan || '-';
        document.getElementById('detailSubmissionNumber').textContent = submission.nomor_pengajuan;
        document.getElementById('detailStatus').innerHTML = getStatusBadge(submission.status_pengajuan).badge;
        document.getElementById('detailSubmissionDate').textContent = formatDate(submission.tanggal_pengajuan);
        document.getElementById('detailUpdateDate').textContent = formatDate(submission.tanggal_update);
        
        document.getElementById('detailFacilities').textContent = submission.fasilitas_status ? submission.fasilitas_status.replace(/_/g, ' ') : 'Belum Diverifikasi';
        document.getElementById('detailTotalAmount').textContent = formatCurrency(submission.total_biaya);
        
        const payment = submission.pembayaran.length > 0 ? submission.pembayaran[0] : null;
        const paymentProofStatusEl = document.getElementById('detailPaymentProof');

        if (payment) {
            if (payment.status_bukti === 'TIDAK_VALID') {
                paymentProofStatusEl.textContent = 'TIDAK VALID';
                paymentProofStatusEl.className = 'font-medium text-red-600';
            } else if (payment.bukti_pembayaran) {
                paymentProofStatusEl.textContent = payment.status_bukti.replace(/_/g, ' ');
                paymentProofStatusEl.className = 'font-medium text-blue-600';
            } 
        } else {
            paymentProofStatusEl.textContent = 'BELUM UPLOAD';
            paymentProofStatusEl.className = 'font-medium text-gray-600';
        }

        const facilityListDetailEl = document.getElementById('facilityListDetail');
        const facilityItemsEl = document.getElementById('facilityItems');
        let rincianHtml = `<div class="flex justify-between items-center p-2 bg-white rounded border"><span class="text-sm text-gray-700">Biaya Pokok Administrasi</span><span class="text-sm font-semibold text-gray-900">${formatCurrency(submission.total_biaya - (submission.biaya_tambahan || 0))}</span></div>`;

        if (submission.kerusakanFasilitas && submission.kerusakanFasilitas.length > 0) {
            submission.kerusakanFasilitas.forEach(item => {
                rincianHtml += `<div class="flex justify-between items-center p-2 bg-white rounded border"><span class="text-sm text-gray-700">${item.nama_fasilitas}</span><span class="text-sm font-semibold text-red-600">+ ${formatCurrency(item.biaya_kerusakan)}</span></div>`;
            });
            facilityListDetailEl.classList.remove('hidden');
        } else {
            facilityListDetailEl.classList.add('hidden');
        }
        facilityItemsEl.innerHTML = rincianHtml;
        facilityListDetailEl.classList.remove('hidden');
        
        document.getElementById('detailModal').classList.remove('hidden');
    };

    window.openFacilityVerificationModal = function(id) {
        currentSubmissionId = id;
        const submission = allSubmissions.find(s => s.Surat_id === id);
        if (!submission) return;
        document.getElementById('facilityStudentName').textContent = submission.mahasiswa.nama;
        document.getElementById('facilityVerificationModal').classList.remove('hidden');
    };

    window.openPaymentVerificationModal = function(id) {
        currentSubmissionId = id;
        const submission = allSubmissions.find(s => s.Surat_id === id);
        if (!submission) return;

        const proofImage = document.getElementById('proofImage');
        const proofPlaceholder = document.getElementById('proofPlaceholder');
        proofImage.classList.remove('zoomed-in');
        document.getElementById('paymentStudentName').textContent = submission.mahasiswa.nama;
        document.getElementById('paymentAmount').textContent = formatCurrency(submission.total_biaya);

        const payment = submission.pembayaran.length > 0 ? submission.pembayaran[0] : null;
        if (payment && payment.bukti_pembayaran) {
            proofImage.src = `/api/pengelola/surat/${id}/bukti-pembayaran`;
            proofImage.classList.remove('hidden');
            proofPlaceholder.classList.add('hidden');
        } else {
            proofImage.classList.add('hidden');
            proofPlaceholder.classList.remove('hidden');
        }
        proofImage.onclick = () => proofImage.classList.toggle('zoomed-in');
        
        document.getElementById('paymentVerificationModal').classList.remove('hidden');
    };
    
    // --- Fungsi Helper Form Verifikasi Fasilitas ---
    window.toggleFacilityForm = function() { 
        const incomplete = document.getElementById('incomplete').checked;
        const facilityForm = document.getElementById('facilityForm');
        
        if (incomplete) {
            facilityForm.classList.remove('hidden');
        } else {
            facilityForm.classList.add('hidden');
            resetFacilityForm();
        }
    };
    window.addFacility = function() { 
        const facilityList = document.getElementById('facilityList');
        const newFacility = document.createElement('div');
        newFacility.className = 'flex gap-2 items-center facility-item';
        newFacility.innerHTML = `
            <input type="text" placeholder="Nama Fasilitas" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="number" placeholder="Harga" class="w-24 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 facility-price" oninput="calculateTotal()">
            <button type="button" onclick="removeFacility(this)" class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs">
                <i class="fas fa-times"></i>
            </button>
        `;
        facilityList.appendChild(newFacility);
    };
    window.removeFacility = function(button) { 
        const facilityList = document.getElementById('facilityList');
        if (facilityList.children.length > 1) {
            button.parentElement.remove();
            calculateTotal();
        }
    };
    window.calculateTotal = function() { 
        const prices = document.querySelectorAll('.facility-price');
        let total = 0;
        prices.forEach(price => {
            total += Number(price.value) || 0;
        });
        document.getElementById('totalAmount').textContent = total.toLocaleString('id-ID');
    };
    function resetFacilityForm() { 
        const facilityList = document.getElementById('facilityList');
        facilityList.innerHTML = `
            <div class="flex gap-2 items-center facility-item">
                <input type="text" placeholder="Nama Fasilitas" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" placeholder="Harga" class="w-24 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 facility-price" oninput="calculateTotal()">
                <button type="button" onclick="removeFacility(this)" class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        calculateTotal();
    };
    
    function showNotification(message, type = 'info') {
        const colors = { success: 'bg-green-500', warning: 'bg-yellow-500', error: 'bg-red-500', info: 'bg-blue-500' };
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
        notification.innerHTML = `<div class="flex items-center"><span>${message}</span></div>`;
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => document.body.removeChild(notification), 300);
        }, 4000);
    }

    // Fungsi untuk memuat ulang tabel
    window.reloadTable = function() {
        if (datatable) {
            datatable.ajax.reload(null, false);
        }
    };

    // =================================================================
    // INISIALISASI JQUERY & DATATABLES
    // =================================================================
    $(document).ready(function() {
        datatable = $('#submissionTable').DataTable({
            processing: true,
            ajax: {
                url: '/api/pengelola/bebas-asrama',
                dataSrc: (json) => {
                    allSubmissions = json.data || []; 
                    return allSubmissions;
                }
            },
            columns: [
                { data: null, render: (data, type, row, meta) => meta.row + 1, className: "text-center", width: "5%" },
                { data: 'mahasiswa.nama', width: "20%" },
                { data: 'mahasiswa.nim' },
                { data: 'tanggal_pengajuan', render: formatDate },
                {
                    data: 'status_pengajuan',
                    render: (data) => {
                        const statusInfo = getStatusBadge(data);
                        return `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusInfo.class}">${statusInfo.badge}</span>`;
                    }
                },
                { data: 'tanggal_update', render: formatDate },
                {
                    data: null, orderable: false,
                    render: (data, type, row) => {
                        let btns = `<button onclick="openDetailModal(${row.Surat_id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">Detail</button>`;
                        if (row.status_pengajuan === 'VERIFIKASI_FASILITAS') {
                            btns += ` <button onclick="openFacilityVerificationModal(${row.Surat_id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs">Verifikasi Fasilitas</button>`;
                        } else if (row.pembayaran.some(p => p.status_bukti === 'BELUM_DIVERIFIKASI' && p.bukti_pembayaran)) {
                            btns += ` <button onclick="openPaymentVerificationModal(${row.Surat_id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">Verifikasi Bayar</button>`;
                        }
                        return `<div class="flex space-x-2">${btns}</div>`;
                    }
                }
            ],

            
            language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json' },
            pageLength: 10,
            order: [[ 0, 'asc' ]] // Urutkan berdasarkan(kolom ke-1)
        });

        async function submitFacilityVerification() { 
            const isLengkap = document.getElementById('complete').checked;
            const status = isLengkap ? "LENGKAP" : "TIDAK_LENGKAP";
            let kerusakan = [];

            if (!isLengkap) {
                document.querySelectorAll('#facilityList .facility-item').forEach(item => {
                    const nama = item.querySelector('input[type="text"]').value;
                    const biaya = item.querySelector('input[type="number"]').value;
                    if (nama && biaya) {
                        kerusakan.push({ nama_fasilitas: nama, biaya_kerusakan: Number(biaya) });
                    }
                });
            }
            
            try {
                const response = await fetch(`/api/pengelola/bebas-asrama/${currentSubmissionId}/verifikasi-fasilitas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fasilitas_status: status, kerusakan: kerusakan })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                showNotification('Verifikasi fasilitas berhasil disimpan.', 'success');
                closeModal('facilityVerificationModal');
                reloadTable(); 
            } catch (error) {
                console.error('Gagal verifikasi fasilitas:', error); 
                showNotification('Gagal menyimpan verifikasi.', 'error'); 
            }
        };
        
        async function approvePayment() {
            try {
                const response = await fetch(`/api/pengelola/pembayaran/${currentSubmissionId}/approve`, { method: 'POST' });
                if (!response.ok) throw new Error('Gagal menyetujui pembayaran.');
                
                showNotification('Pembayaran berhasil diverifikasi.', 'success');
                closeModal('paymentVerificationModal');
                reloadTable();
            } catch(error) {
                showNotification(error.message, 'error');
            }
        }
        
        async function rejectPayment() {
            try {
                const response = await fetch(`/api/pengelola/pembayaran/${currentSubmissionId}/reject`, { method: 'POST' });
                if (!response.ok) throw new Error('Gagal menolak pembayaran.');
                
                showNotification('Pembayaran berhasil ditolak.', 'warning');
                closeModal('paymentVerificationModal');
                reloadTable();
            } catch(error) {
                showNotification(error.message, 'error');
            }
        }
        
        // --- EVENT LISTENER BARU (menggunakan JQuery) ---
        $('#submitFacilityBtn').on('click', submitFacilityVerification);
        $('#approvePaymentBtn').on('click', approvePayment);
        $('#rejectPaymentBtn').on('click', rejectPayment);
    });
</script>