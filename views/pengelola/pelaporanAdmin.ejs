<div class="p-6">
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold mb-4">Daftar Pelaporan Kerusakan</h2>
    <div class="overflow-x-auto">
    <table class="w-full text-sm min-w-[800px]" id="adminLaporanTable">
      <thead>
        <tr class="text-left">
          <th class="p-2">Tanggal Submit</th>
          <th class="p-2">Mahasiswa</th>
          <th class="p-2">Jenis</th>
          <th class="p-2">Lokasi</th>
          <th class="p-2">Deskripsi</th>
          <th class="p-2">Foto</th>
          <th class="p-2">Status</th>
          <th class="p-2">Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    </div>
  </div>
</div>

<script>
async function loadAdminPelaporan() {
  const res = await fetch('/api/pengelola/pelaporan');
  const json = await res.json();
  const tbody = document.querySelector('#adminLaporanTable tbody');
  tbody.innerHTML = '';
  if (json.success && Array.isArray(json.data)) {
    const data = [...json.data].sort((a,b)=> new Date(b.date_submitted) - new Date(a.date_submitted));
    data.forEach(item => {
      const tr = document.createElement('tr');
      const fotoLink = item.photo ? `<a href="${item.photo}" target="_blank" class="text-blue-600">Lihat</a>` : '-';
      tr.innerHTML = `
        <td class="p-2">${new Date(item.date_submitted).toLocaleString('id-ID')}</td>
        <td class="p-2">${item.mahasiswa?.nama || '-'} (${item.mahasiswa?.nim || '-'})</td>
        <td class="p-2">${item.jenis || '-'}</td>
        <td class="p-2">${item.location || '-'}</td>
        <td class="p-2">${item.description}</td>
        <td class="p-2">${fotoLink}</td>
        <td class="p-2"><span class="px-2 py-1 rounded text-white ${statusColor(item.status)}">${item.status}</span></td>
        <td class="p-2 space-x-2">
          <button class="bg-yellow-600 text-white px-2 py-1 rounded" onclick="updateStatus(${item.laporan_id}, 'ditinjau')">Ditinjau</button>
          <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="updateStatus(${item.laporan_id}, 'ditangani')">Ditangani</button>
          <button class="bg-green-600 text-white px-2 py-1 rounded" onclick="updateStatus(${item.laporan_id}, 'selesai')">Selesai</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
}

function statusColor(s) {
  switch (s) {
    case 'ditangani': return 'bg-blue-600';
    case 'selesai': return 'bg-green-600';
    default: return 'bg-gray-600';
  }
}

async function updateStatus(id, status) {
  // Ambil data baris untuk konfirmasi lebih informatif
  const row = Array.from(document.querySelectorAll('#adminLaporanTable tbody tr')).find(r => {
    const btns = r.querySelectorAll('button');
    return Array.from(btns).some(b => b.getAttribute('onclick')?.includes(`(${id},`));
  });
  const jenis = row?.children[2]?.textContent || '-';
  const lokasi = row?.children[3]?.textContent || '-';
  openConfirmModal(id, status, jenis, lokasi);
}

loadAdminPelaporan();
</script>

<!-- Modal Konfirmasi Status Pelaporan -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-4">
      <h3 class="text-lg font-semibold mb-2">Konfirmasi Perubahan Status</h3>
      <p id="confirmText" class="text-sm text-gray-700 mb-3"></p>
      <input type="hidden" id="confirmLaporanId" />
      <input type="hidden" id="confirmStatus" />
      <div class="mt-4 flex justify-end space-x-2">
        <button id="confirmCancelBtn" class="px-4 py-2 rounded border">Batal</button>
        <button id="confirmOkBtn" class="px-4 py-2 rounded bg-blue-600 text-white">Oke</button>
      </div>
    </div>
  </div>
</div>

<script>
function openConfirmModal(id, status, jenis, lokasi) {
  const modal = document.getElementById('confirmModal');
  const text = document.getElementById('confirmText');
  const inputId = document.getElementById('confirmLaporanId');
  const inputStatus = document.getElementById('confirmStatus');
  const label = status === 'ditinjau' ? 'menandai Ditinjau' : status === 'ditangani' ? 'menandai Ditangani' : 'menandai Selesai';
  text.textContent = `Yakin ${label} untuk laporan jenis "${jenis}" di lokasi "${lokasi}"?`;
  inputId.value = id;
  inputStatus.value = status;
  modal.classList.remove('hidden');
}

function closeConfirmModal() {
  const modal = document.getElementById('confirmModal');
  modal.classList.add('hidden');
}

async function confirmUpdateStatus() {
  const id = document.getElementById('confirmLaporanId').value;
  const status = document.getElementById('confirmStatus').value;
  const okBtn = document.getElementById('confirmOkBtn');
  okBtn.disabled = true;
  try {
    const res = await fetch(`/api/pengelola/pelaporan/${id}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    const json = await res.json();
    if (!res.ok) {
      openNotifyModal('error', json.message || 'Gagal memperbarui status laporan.');
    } else {
      closeConfirmModal();
      openNotifyModal('success', 'Status laporan berhasil diperbarui.');
      loadAdminPelaporan();
    }
  } catch (e) {
    openNotifyModal('error', e.message || 'Terjadi kesalahan saat memperbarui status.');
  } finally {
    okBtn.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('confirmCancelBtn')?.addEventListener('click', closeConfirmModal);
  document.getElementById('confirmOkBtn')?.addEventListener('click', confirmUpdateStatus);
  document.getElementById('notifyOkBtn')?.addEventListener('click', closeNotifyModal);
});
</script>

<!-- Modal Notifikasi Seragam -->
<div id="notifyModal" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-4">
      <div id="notifyIcon" class="text-2xl mb-2">üîî</div>
      <div id="notifyText" class="text-sm text-gray-700 mb-3"></div>
      <div class="mt-4 flex justify-end">
        <button id="notifyOkBtn" class="px-4 py-2 rounded bg-blue-600 text-white">Oke</button>
      </div>
    </div>
  </div>
</div>

<script>
function openNotifyModal(type, htmlText) {
  const modal = document.getElementById('notifyModal');
  const icon = document.getElementById('notifyIcon');
  const text = document.getElementById('notifyText');
  text.innerHTML = htmlText;
  if (type === 'success') {
    icon.textContent = '‚úÖ';
  } else if (type === 'error') {
    icon.textContent = '‚ö†Ô∏è';
  } else {
    icon.textContent = 'üîî';
  }
  modal.classList.remove('hidden');
}

function closeNotifyModal() {
  document.getElementById('notifyModal').classList.add('hidden');
}
</script>